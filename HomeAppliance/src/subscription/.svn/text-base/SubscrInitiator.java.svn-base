package subscription;

import java.text.SimpleDateFormat;

import jade.content.ContentElement;
import jade.content.lang.Codec.CodecException;
import jade.content.onto.OntologyException;
import jade.content.onto.UngroundedException;
import jade.lang.acl.ACLMessage;
import jade.proto.SubscriptionInitiator;

import agents.SubscriberAgent;

import onto.*;

/**
 * Обслуживание всех операций по подписке со стороны подписчика
 */
public class SubscrInitiator extends SubscriptionInitiator {
	private static final long serialVersionUID = 2596974171933664345L;
	protected SubscriberAgent myAgent;
	private String FORMAT = "yyyy-MM-dd hh:mm:ss"; // Формат записи даты
	private SimpleDateFormat sdf = new SimpleDateFormat(FORMAT);

	/**
	 * Конструктор
	 */
	public SubscrInitiator(SubscriberAgent a, ACLMessage msg) {
		super(a, msg);
		myAgent = a;	
	}

	/**
	 * @see jade.proto.SubscriptionInitiator#handleAgree(jade.lang.acl.ACLMessage)
	 * 
	 * @param agree
	 *            - message with AGREE performative
	 */
	@Override
	protected void handleAgree(ACLMessage agree) {
		System.out.println("Agent " + myAgent.getAID().getName() + " received the AGREE from agent " 
							+ agree.getSender().getName());
	}

	/**
	 * @see jade.proto.SubscriptionInitiator#handleRefuse(jade.lang.acl.ACLMessage)
	 * 
	 * @param refuse
	 *            - message with REFUSE performative
	 */
	@Override
	protected void handleRefuse(ACLMessage refuse) {
		System.out.println("Agent " + myAgent.getAID().getName() + " received the REFUSE from agent " 
							+ refuse.getSender().getName());
	}

	/**
	 * @see jade.proto.SubscriptionInitiator#handleInform(jade.lang.acl.ACLMessage)
	 * 
	 * @param inform
	 *            - message with INFORM performative
	 */
	@Override
	protected void handleInform(ACLMessage inform) {
		// Вывод информации в консоль о получении сообщения 
		System.out.println("Agent " + myAgent.getAID().getName() + " received the INFORM from agent " 
							+ inform.getSender().getName());

		try {
			// Извлечение контекста принятого сообщения
			ContentElement ce = myAgent.getContentManager().extractContent(inform);
			
			if (ce instanceof SendMessage){	
				SendMessage smsg = (SendMessage) ce;
				// Вывод в консоль полученных данных: о файле и дате его изменения
				System.out.println(myAgent.getAID().getName() + " Received data " + smsg.getMessage().getFilePath()
									+ " " + sdf.format(smsg.getMessage().getLastDateMod()));
			}
		
		} catch (UngroundedException e) {
			e.printStackTrace();
		} catch (CodecException e) {
			e.printStackTrace();
		} catch (OntologyException e) {
			e.printStackTrace();
		} 
	}

}
